<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Signal Terminal â€” AI Stock Analysis</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #060a14;
    --panel: #0f172a;
    --border: #1e293b;
    --text: #e2e8f0;
    --muted: #94a3b8;
    --dim: #64748b;
    --green: #00e676;
    --blue: #00b0ff;
    --red: #ef5350;
    --yellow: #ffc107;
    --purple: #e040fb;
    --orange: #ff9800;
    --strong-green: #00e676;
    --strong-red: #d50000;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'JetBrains Mono', 'SF Mono', 'Fira Code', monospace;
    min-height: 100vh;
    -webkit-font-smoothing: antialiased;
  }

  ::-webkit-scrollbar { width: 5px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  /* Header */
  .header {
    border-bottom: 1px solid var(--border);
    padding: 14px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: linear-gradient(180deg, var(--panel) 0%, var(--bg) 100%);
    position: sticky;
    top: 0;
    z-index: 50;
  }

  .header-left { display: flex; align-items: center; gap: 10px; }

  .logo {
    width: 30px; height: 30px; border-radius: 7px;
    background: linear-gradient(135deg, #00e676, #00b0ff);
    display: flex; align-items: center; justify-content: center;
    font-size: 14px; font-weight: 800;
  }

  .header-title { font-size: 14px; font-weight: 700; letter-spacing: 1px; }
  .header-sub { font-size: 9px; color: var(--dim); letter-spacing: 2px; }

  .live-dot {
    width: 6px; height: 6px; border-radius: 50%;
    background: var(--green);
    box-shadow: 0 0 8px rgba(0,230,118,0.4);
    display: inline-block;
  }

  /* Search */
  .search-wrap {
    padding: 20px 16px 0;
    max-width: 900px;
    margin: 0 auto;
  }

  .search-bar {
    display: flex; gap: 8px;
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 4px;
  }

  .search-input {
    flex: 1; background: transparent; border: none; outline: none;
    color: var(--text); font-size: 15px; padding: 12px 14px;
    letter-spacing: 1px; font-family: inherit;
  }

  .search-input::placeholder { color: #334155; }

  .analyze-btn {
    background: linear-gradient(135deg, #00e676, #00b0ff);
    border: none; border-radius: 8px; padding: 12px 24px;
    color: var(--bg); font-size: 12px; font-weight: 700;
    font-family: inherit; letter-spacing: 1px;
    cursor: pointer; transition: all 0.2s; white-space: nowrap;
  }

  .analyze-btn:hover { filter: brightness(1.1); transform: translateY(-1px); }
  .analyze-btn:disabled { background: var(--border); color: var(--dim); cursor: not-allowed; transform: none; }

  /* Content */
  .content {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px 16px;
  }

  /* Panels */
  .panel {
    background: linear-gradient(180deg, var(--panel) 0%, var(--bg) 100%);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 18px;
    margin-bottom: 16px;
  }

  .panel-title {
    margin: 0 0 14px 0;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 2px;
    color: var(--dim);
    border-bottom: 1px solid var(--border);
    padding-bottom: 10px;
    font-weight: 600;
  }

  /* Metric Cards */
  .metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 8px;
    margin-bottom: 16px;
  }

  .metric-card {
    background: linear-gradient(135deg, #111827 0%, var(--bg) 100%);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px;
    position: relative;
    overflow: hidden;
  }

  .metric-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    opacity: 0.5;
  }

  .metric-label {
    font-size: 10px; color: var(--dim);
    text-transform: uppercase;
    letter-spacing: 1.5px;
    margin-bottom: 6px;
  }

  .metric-value {
    font-size: 16px; font-weight: 700;
    color: var(--text);
    word-break: break-word;
  }

  .metric-sub {
    font-size: 10px; color: var(--dim);
    margin-top: 3px;
  }

  /* Factor Bars */
  .factor-bar { margin-bottom: 14px; }

  .factor-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 4px;
  }

  .factor-label { font-size: 12px; color: var(--muted); }
  .factor-score { font-size: 12px; font-weight: 600; }

  .factor-track {
    height: 6px;
    background: var(--border);
    border-radius: 3px;
    overflow: hidden;
  }

  .factor-fill {
    height: 100%;
    border-radius: 3px;
    transition: width 1s ease-out;
  }

  /* Two-column layout */
  .two-col {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 16px;
    margin-bottom: 16px;
  }

  .two-col .panel { margin-bottom: 0; }

  /* List items */
  .list-item {
    display: flex; gap: 8px;
    margin-bottom: 10px;
    font-size: 11px;
    color: var(--muted);
    line-height: 1.6;
  }

  .list-bullet { font-weight: 700; flex-shrink: 0; }

  /* Gauge */
  .gauge-wrap {
    position: relative;
    width: 240px;
    height: 130px;
    margin: 0 auto;
    overflow: hidden;
  }

  .gauge-arc {
    position: absolute;
    bottom: 0; left: 0; right: 0;
    height: 120px;
    border-radius: 120px 120px 0 0;
    background: conic-gradient(from 0.75turn, var(--strong-red), var(--red), var(--yellow), #66bb6a, var(--strong-green));
    opacity: 0.3;
  }

  .gauge-inner {
    position: absolute;
    bottom: 0; left: 12px; right: 12px;
    height: 108px;
    border-radius: 108px 108px 0 0;
    background: var(--bg);
  }

  .gauge-needle-wrap {
    position: absolute;
    bottom: 0; left: 50%;
    transform: translateX(-50%);
    width: 2px; height: 108px;
  }

  .gauge-needle {
    position: absolute;
    bottom: 0; left: 50%;
    width: 3px; height: 88%;
    background: #fff;
    transform-origin: bottom center;
    transition: transform 1.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    border-radius: 2px;
    box-shadow: 0 0 10px rgba(255,255,255,0.6);
    z-index: 10;
  }

  .gauge-needle-tip {
    width: 10px; height: 10px;
    border-radius: 50%;
    background: #fff;
    position: absolute;
    top: -2px; left: 50%;
    transform: translateX(-50%);
  }

  .gauge-center {
    position: absolute;
    bottom: -4px; left: 50%;
    transform: translateX(-50%);
    width: 16px; height: 16px;
    border-radius: 50%;
    background: #1a2340;
    border: 2px solid #fff;
    z-index: 20;
  }

  .gauge-label-left {
    position: absolute;
    bottom: 4px; left: 8px;
    font-size: 9px; color: var(--dim);
  }

  .gauge-label-right {
    position: absolute;
    bottom: 4px; right: 12px;
    font-size: 9px; color: var(--dim);
  }

  .signal-label {
    margin-top: 14px;
    font-size: 26px;
    font-weight: 800;
    letter-spacing: 3px;
    text-align: center;
  }

  .signal-score {
    font-size: 13px;
    color: var(--muted);
    margin-top: 6px;
    text-align: center;
  }

  /* Loading */
  .loading-wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 60px 20px;
  }

  .radar {
    position: relative;
    width: 80px; height: 80px;
    margin-bottom: 24px;
  }

  .radar-ring {
    position: absolute; inset: 0;
    border-radius: 50%;
    border: 2px solid var(--border);
  }

  .radar-ring-inner {
    position: absolute; inset: 4px;
    border-radius: 50%;
    border: 1px solid var(--border);
  }

  .radar-sweep {
    position: absolute; inset: 0;
    border-radius: 50%;
    border: 2px solid transparent;
    border-top: 2px solid var(--green);
    animation: spin 1.2s linear infinite;
  }

  .radar-dot {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--green);
    animation: pulse 1.5s ease-in-out infinite;
    box-shadow: 0 0 12px rgba(0,230,118,0.4);
  }

  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes pulse { 0%,100% { opacity:.3; } 50% { opacity:1; } }
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(16px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .fade-up { animation: fadeUp 0.5s ease-out both; }

  /* Error */
  .error-box {
    background: #1a0a0a;
    border: 1px solid #7f1d1d;
    border-radius: 10px;
    padding: 20px;
    font-size: 13px;
  }

  .error-msg { color: #fca5a5; margin-bottom: 12px; }

  .error-btn {
    background: transparent;
    border: 1px solid #7f1d1d;
    border-radius: 6px;
    padding: 6px 14px;
    color: #fca5a5;
    font-size: 11px;
    cursor: pointer;
    font-family: inherit;
    letter-spacing: 1px;
    margin-right: 8px;
  }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 80px 20px;
  }

  .empty-icon { font-size: 52px; opacity: 0.2; margin-bottom: 16px; }
  .empty-title { font-size: 14px; letter-spacing: 2px; color: var(--dim); margin-bottom: 8px; }
  .empty-sub { font-size: 11px; letter-spacing: 1px; color: #1e293b; }

  /* API Key modal */
  .api-overlay {
    position: fixed;
    inset: 0;
    background: rgba(6,10,20,0.92);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    padding: 20px;
  }

  .api-modal {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 28px;
    max-width: 440px;
    width: 100%;
  }

  .api-modal h2 {
    font-size: 16px;
    font-weight: 700;
    letter-spacing: 1px;
    margin-bottom: 8px;
  }

  .api-modal p {
    font-size: 12px;
    color: var(--muted);
    line-height: 1.7;
    margin-bottom: 16px;
  }

  .api-modal a {
    color: var(--green);
    text-decoration: none;
  }

  .api-modal a:hover { text-decoration: underline; }

  .api-input {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 14px;
    color: var(--text);
    font-size: 13px;
    font-family: inherit;
    outline: none;
    margin-bottom: 14px;
  }

  .api-input:focus { border-color: var(--green); }

  .api-submit {
    width: 100%;
    background: linear-gradient(135deg, #00e676, #00b0ff);
    border: none;
    border-radius: 8px;
    padding: 12px;
    color: var(--bg);
    font-size: 13px;
    font-weight: 700;
    font-family: inherit;
    letter-spacing: 1px;
    cursor: pointer;
  }

  .api-submit:hover { filter: brightness(1.1); }

  .footer {
    text-align: center;
    padding: 24px 0 16px;
    font-size: 9px;
    color: #1e293b;
    letter-spacing: 0.5px;
    line-height: 1.8;
  }

  /* Factor detail */
  .factor-detail { margin-bottom: 14px; }
  .factor-detail-label {
    font-size: 11px; font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 3px;
  }
  .factor-detail-text {
    font-size: 11px;
    color: var(--muted);
    line-height: 1.7;
  }

  /* Ticker display */
  .ticker-exchange { font-size: 13px; color: var(--dim); }
  .ticker-symbol { font-size: 22px; font-weight: 800; color: var(--green); letter-spacing: 2px; }
  .ticker-name { font-size: 13px; color: var(--muted); margin-bottom: 12px; }
  .price-big { font-size: 32px; font-weight: 800; }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-left">
    <div class="logo">â—Š</div>
    <div>
      <div class="header-title">SIGNAL TERMINAL</div>
      <div class="header-sub">AI-POWERED STOCK ANALYSIS</div>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:6px;">
    <span class="live-dot"></span>
    <span style="font-size:9px;color:var(--dim);letter-spacing:1px">LIVE</span>
    <button onclick="showApiModal()" style="background:transparent;border:1px solid var(--border);border-radius:5px;padding:4px 10px;color:var(--dim);font-size:9px;font-family:inherit;cursor:pointer;margin-left:8px;letter-spacing:1px">API KEY</button>
  </div>
</div>

<!-- Search -->
<div class="search-wrap">
  <div class="search-bar">
    <input class="search-input" id="tickerInput" type="text" placeholder="Enter ticker (AAPL, NVDA, TSLA...)" autocomplete="off">
    <button class="analyze-btn" id="analyzeBtn" onclick="analyze()">ANALYZE</button>
  </div>
</div>

<!-- API Key Modal -->
<div class="api-overlay" id="apiModal" style="display:none">
  <div class="api-modal">
    <h2>ðŸ”‘ API Key Setup</h2>
    <p>
      This tool uses <a href="https://financialmodelingprep.com/developer/docs" target="_blank">Financial Modeling Prep</a> for live market data. Get a free API key in 30 seconds:
    </p>
    <p>
      1. Go to <a href="https://financialmodelingprep.com/register" target="_blank">financialmodelingprep.com/register</a><br>
      2. Create a free account<br>
      3. Copy your API key and paste below
    </p>
    <input class="api-input" id="apiKeyInput" type="text" placeholder="Paste your FMP API key here...">
    <button class="api-submit" onclick="saveApiKey()">SAVE & START ANALYZING</button>
    <p style="font-size:10px;color:#334155;margin-top:12px;margin-bottom:0">
      Key is stored locally in your browser. Free tier: 250 requests/day.
    </p>
  </div>
</div>

<!-- Content -->
<div class="content" id="content">
  <div class="empty-state" id="emptyState">
    <div class="empty-icon">â—Š</div>
    <div class="empty-title">ENTER A TICKER TO BEGIN</div>
    <div class="empty-sub">7-factor analysis: earnings Â· sentiment Â· analyst targets Â· technicals Â· valuation Â· momentum Â· risk</div>
  </div>
</div>

<script>
// â”€â”€ State â”€â”€
let apiKey = localStorage.getItem('fmp_api_key') || '';
const API_BASE = 'https://financialmodelingprep.com/api/v3';

// â”€â”€ Init â”€â”€
document.addEventListener('DOMContentLoaded', () => {
  if (!apiKey) showApiModal();
  document.getElementById('tickerInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') analyze();
  });
  document.getElementById('tickerInput').addEventListener('input', e => {
    e.target.value = e.target.value.toUpperCase();
  });
  document.getElementById('tickerInput').focus();
});

function showApiModal() {
  document.getElementById('apiModal').style.display = 'flex';
  document.getElementById('apiKeyInput').value = apiKey;
}

function saveApiKey() {
  const key = document.getElementById('apiKeyInput').value.trim();
  if (!key) return;
  apiKey = key;
  localStorage.setItem('fmp_api_key', key);
  document.getElementById('apiModal').style.display = 'none';
  document.getElementById('tickerInput').focus();
}

// â”€â”€ Data Fetching â”€â”€
async function fetchJSON(url) {
  const res = await fetch(url);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const data = await res.json();
  if (data['Error Message']) throw new Error(data['Error Message']);
  return data;
}

async function fetchStockData(ticker) {
  const [quote, profile, ratios, income, recommendations] = await Promise.allSettled([
    fetchJSON(`${API_BASE}/quote/${ticker}?apikey=${apiKey}`),
    fetchJSON(`${API_BASE}/profile/${ticker}?apikey=${apiKey}`),
    fetchJSON(`${API_BASE}/ratios-ttm/${ticker}?apikey=${apiKey}`),
    fetchJSON(`${API_BASE}/income-statement/${ticker}?period=quarter&limit=8&apikey=${apiKey}`),
    fetchJSON(`${API_BASE}/analyst-estimates/${ticker}?limit=4&apikey=${apiKey}`),
  ]);

  const q = quote.status === 'fulfilled' && quote.value[0] ? quote.value[0] : null;
  const p = profile.status === 'fulfilled' && profile.value[0] ? profile.value[0] : null;
  const r = ratios.status === 'fulfilled' && ratios.value[0] ? ratios.value[0] : null;
  const inc = income.status === 'fulfilled' ? income.value : [];
  const est = recommendations.status === 'fulfilled' ? recommendations.value : [];

  if (!q) throw new Error(`No data found for ticker "${ticker}". Check the symbol and try again.`);

  return { quote: q, profile: p, ratios: r, income: inc, estimates: est };
}

// â”€â”€ Analysis Engine â”€â”€
function analyzeStock(data) {
  const { quote: q, profile: p, ratios: r, income: inc, estimates: est } = data;

  // Helper
  const fmt = (n, d = 2) => n != null ? Number(n).toFixed(d) : 'N/A';
  const fmtB = (n) => {
    if (n == null) return 'N/A';
    const abs = Math.abs(n);
    if (abs >= 1e12) return (n / 1e12).toFixed(2) + 'T';
    if (abs >= 1e9) return (n / 1e9).toFixed(2) + 'B';
    if (abs >= 1e6) return (n / 1e6).toFixed(1) + 'M';
    return n.toLocaleString();
  };
  const clamp = (v, min, max) => Math.max(min, Math.min(max, v));

  // â”€â”€ Factor Scoring â”€â”€

  // 1. EARNINGS
  let earningsScore = 0;
  let earningsDetail = '';
  if (inc.length >= 2) {
    const latest = inc[0];
    const yoyComp = inc.length >= 4 ? inc[4] : inc[inc.length - 1];
    const revGrowth = yoyComp?.revenue ? ((latest.revenue - yoyComp.revenue) / Math.abs(yoyComp.revenue)) * 100 : null;
    const epsGrowth = yoyComp?.eps ? ((latest.eps - yoyComp.eps) / Math.abs(yoyComp.eps || 1)) * 100 : null;
    const grossMargin = latest.revenue ? (latest.grossProfit / latest.revenue) * 100 : null;

    if (revGrowth !== null) earningsScore += clamp(revGrowth * 1.5, -40, 40);
    if (epsGrowth !== null) earningsScore += clamp(epsGrowth * 0.8, -30, 30);
    if (grossMargin !== null) earningsScore += grossMargin > 40 ? 15 : grossMargin > 25 ? 5 : -10;

    earningsScore = clamp(Math.round(earningsScore), -100, 100);
    earningsDetail = `Latest quarterly revenue: $${fmtB(latest.revenue)}. `;
    if (revGrowth !== null) earningsDetail += `Revenue growth: ${revGrowth > 0 ? '+' : ''}${fmt(revGrowth, 1)}% YoY. `;
    if (epsGrowth !== null) earningsDetail += `EPS growth: ${epsGrowth > 0 ? '+' : ''}${fmt(epsGrowth, 1)}% YoY. `;
    if (grossMargin !== null) earningsDetail += `Gross margin: ${fmt(grossMargin, 1)}%.`;
  } else {
    earningsDetail = 'Insufficient earnings data available.';
  }

  // 2. SENTIMENT
  let sentimentScore = 0;
  let sentimentDetail = '';
  const changePercent = q.changesPercentage || 0;
  sentimentScore += clamp(changePercent * 5, -30, 30);
  if (q.volume && q.avgVolume) {
    const volRatio = q.volume / q.avgVolume;
    if (volRatio > 1.5) sentimentScore += changePercent > 0 ? 20 : -20;
    sentimentDetail += `Volume ratio: ${fmt(volRatio, 1)}x average. `;
  }
  sentimentScore = clamp(Math.round(sentimentScore), -100, 100);
  sentimentDetail += `Today's change: ${changePercent > 0 ? '+' : ''}${fmt(changePercent, 2)}%. `;
  sentimentDetail += `Trading at $${fmt(q.price)} with ${fmtB(q.volume)} shares traded.`;

  // 3. ANALYST TARGETS
  let analystScore = 0;
  let analystDetail = '';
  if (q.price && p?.targetConsensus) {
    const upside = ((p.targetConsensus - q.price) / q.price) * 100;
    analystScore = clamp(Math.round(upside * 3), -80, 80);
    analystDetail = `Avg analyst target: $${fmt(p.targetConsensus)}. Implied ${upside > 0 ? 'upside' : 'downside'}: ${upside > 0 ? '+' : ''}${fmt(upside, 1)}%. `;
  }
  // Use analyst recommendation from profile
  if (p?.rating) {
    analystDetail += `Rating: ${p.rating}. `;
    if (p.rating === 'S-' || p.rating === 'F') analystScore -= 20;
  }
  analystScore = clamp(analystScore, -100, 100);
  if (!analystDetail) analystDetail = 'Limited analyst coverage data available.';

  // 4. TECHNICALS
  let technicalScore = 0;
  let technicalDetail = '';
  if (q.yearHigh && q.yearLow) {
    const range = q.yearHigh - q.yearLow;
    const position = range > 0 ? ((q.price - q.yearLow) / range) : 0.5;
    // Above midpoint is bullish, but near top might mean overextended
    if (position > 0.8) { technicalScore = 10; technicalDetail += 'Near 52-week high â€” momentum but potentially overextended. '; }
    else if (position > 0.6) { technicalScore = 25; technicalDetail += 'Upper half of 52-week range â€” positive momentum. '; }
    else if (position > 0.4) { technicalScore = 0; technicalDetail += 'Mid-range of 52-week band â€” neutral positioning. '; }
    else if (position > 0.2) { technicalScore = -15; technicalDetail += 'Lower half of 52-week range â€” bearish positioning. '; }
    else { technicalScore = -25; technicalDetail += 'Near 52-week low â€” deep weakness or potential value. '; }

    if (q.priceAvg50) {
      const vs50 = ((q.price - q.priceAvg50) / q.priceAvg50) * 100;
      technicalScore += clamp(Math.round(vs50 * 2), -25, 25);
      technicalDetail += `${fmt(Math.abs(vs50), 1)}% ${vs50 > 0 ? 'above' : 'below'} 50-day MA. `;
    }
    if (q.priceAvg200) {
      const vs200 = ((q.price - q.priceAvg200) / q.priceAvg200) * 100;
      technicalScore += clamp(Math.round(vs200), -20, 20);
      technicalDetail += `${fmt(Math.abs(vs200), 1)}% ${vs200 > 0 ? 'above' : 'below'} 200-day MA.`;
    }
  }
  technicalScore = clamp(Math.round(technicalScore), -100, 100);

  // 5. VALUATION
  let valuationScore = 0;
  let valuationDetail = '';
  const pe = q.pe;
  if (pe && pe > 0) {
    if (pe > 200) { valuationScore = -60; valuationDetail += `P/E of ${fmt(pe, 1)}x is extremely elevated. `; }
    else if (pe > 80) { valuationScore = -40; valuationDetail += `P/E of ${fmt(pe, 1)}x is very high â€” priced for perfection. `; }
    else if (pe > 35) { valuationScore = -15; valuationDetail += `P/E of ${fmt(pe, 1)}x is above market average. `; }
    else if (pe > 15) { valuationScore = 10; valuationDetail += `P/E of ${fmt(pe, 1)}x is reasonable. `; }
    else { valuationScore = 30; valuationDetail += `P/E of ${fmt(pe, 1)}x suggests value territory. `; }
  } else if (pe && pe < 0) {
    valuationScore = -30;
    valuationDetail += 'Negative earnings â€” company is unprofitable. ';
  }

  if (r?.priceToBookRatioTTM) {
    const pb = r.priceToBookRatioTTM;
    valuationDetail += `P/B: ${fmt(pb, 1)}x. `;
    if (pb > 15) valuationScore -= 15;
    else if (pb < 3) valuationScore += 10;
  }
  if (r?.priceEarningsToGrowthRatioTTM) {
    const peg = r.priceEarningsToGrowthRatioTTM;
    if (peg > 0 && peg < 1) { valuationScore += 20; valuationDetail += `PEG ${fmt(peg, 2)} â€” undervalued vs growth. `; }
    else if (peg > 3) { valuationScore -= 15; valuationDetail += `PEG ${fmt(peg, 2)} â€” expensive vs growth rate. `; }
  }
  valuationScore = clamp(Math.round(valuationScore), -100, 100);

  // 6. MOMENTUM
  let momentumScore = 0;
  let momentumDetail = '';
  // Quarterly comparison
  if (inc.length >= 2) {
    const revTrend = inc[0].revenue && inc[1].revenue
      ? ((inc[0].revenue - inc[1].revenue) / Math.abs(inc[1].revenue)) * 100
      : null;
    if (revTrend !== null) {
      momentumScore += clamp(Math.round(revTrend * 3), -40, 40);
      momentumDetail += `Sequential revenue change: ${revTrend > 0 ? '+' : ''}${fmt(revTrend, 1)}%. `;
    }
  }
  // Price momentum
  if (q.priceAvg50 && q.priceAvg200) {
    if (q.priceAvg50 > q.priceAvg200) {
      momentumScore += 20;
      momentumDetail += '50-day MA above 200-day MA (golden cross setup). ';
    } else {
      momentumScore -= 15;
      momentumDetail += '50-day MA below 200-day MA (death cross risk). ';
    }
  }
  momentumScore = clamp(Math.round(momentumScore), -100, 100);

  // 7. RISK
  let riskScore = 0;
  let riskDetail = '';
  const beta = p?.beta || q?.beta;
  if (beta) {
    if (beta > 2) { riskScore -= 30; riskDetail += `High beta of ${fmt(beta, 2)} â€” very volatile. `; }
    else if (beta > 1.3) { riskScore -= 15; riskDetail += `Elevated beta of ${fmt(beta, 2)} â€” above-market volatility. `; }
    else if (beta < 0.8) { riskScore += 15; riskDetail += `Low beta of ${fmt(beta, 2)} â€” defensive characteristics. `; }
    else { riskScore += 5; riskDetail += `Beta of ${fmt(beta, 2)} â€” moderate volatility. `; }
  }

  if (r?.debtEquityRatioTTM) {
    const de = r.debtEquityRatioTTM;
    if (de > 2) { riskScore -= 25; riskDetail += `D/E ratio of ${fmt(de, 1)}x â€” highly leveraged. `; }
    else if (de > 1) { riskScore -= 10; riskDetail += `D/E ratio of ${fmt(de, 1)}x â€” moderate leverage. `; }
    else { riskScore += 10; riskDetail += `D/E ratio of ${fmt(de, 1)}x â€” conservative balance sheet. `; }
  }

  if (r?.currentRatioTTM) {
    const cr = r.currentRatioTTM;
    if (cr < 1) { riskScore -= 20; riskDetail += `Current ratio ${fmt(cr, 2)} â€” liquidity concern. `; }
    else if (cr > 2) { riskScore += 10; riskDetail += `Current ratio ${fmt(cr, 2)} â€” strong liquidity. `; }
  }
  riskScore = clamp(Math.round(riskScore), -100, 100);

  // â”€â”€ Overall Score â”€â”€
  const weights = { earnings: 0.2, sentiment: 0.1, analystTargets: 0.15, technicals: 0.15, valuation: 0.15, momentum: 0.15, risk: 0.1 };
  const factors = { earnings: earningsScore, sentiment: sentimentScore, analystTargets: analystScore, technicals: technicalScore, valuation: valuationScore, momentum: momentumScore, risk: riskScore };
  let confidenceScore = Math.round(
    factors.earnings * weights.earnings +
    factors.sentiment * weights.sentiment +
    factors.analystTargets * weights.analystTargets +
    factors.technicals * weights.technicals +
    factors.valuation * weights.valuation +
    factors.momentum * weights.momentum +
    factors.risk * weights.risk
  );
  confidenceScore = clamp(confidenceScore, -100, 100);

  // â”€â”€ Generate catalysts and risks â”€â”€
  const catalysts = [];
  const risks = [];

  if (earningsScore > 15) catalysts.push('Strong earnings momentum with positive growth trajectory');
  if (analystScore > 15) catalysts.push(`Analyst targets imply upside from current price of $${fmt(q.price)}`);
  if (technicalScore > 15) catalysts.push('Favorable technical positioning above key moving averages');
  if (momentumScore > 15) catalysts.push('Revenue momentum accelerating on a sequential basis');
  if (riskScore > 10) catalysts.push('Conservative balance sheet provides financial flexibility');
  if (factors.valuation > 10) catalysts.push('Attractive valuation relative to growth and peers');
  if (catalysts.length === 0) catalysts.push('No strong bullish catalysts identified at current levels');

  if (valuationScore < -20) risks.push(`Elevated valuation (P/E ${fmt(pe, 1)}x) leaves limited margin of safety`);
  if (riskScore < -15) risks.push('Balance sheet or volatility metrics indicate elevated risk');
  if (earningsScore < -15) risks.push('Declining earnings or revenue trajectory raises concerns');
  if (technicalScore < -15) risks.push('Weak technical positioning below key moving averages');
  if (analystScore < -15) risks.push('Analyst targets imply downside from current levels');
  if (momentumScore < -15) risks.push('Negative revenue momentum may pressure near-term outlook');
  if (risks.length === 0) risks.push('No major risk flags identified at this time');

  // â”€â”€ Summary â”€â”€
  let signal;
  if (confidenceScore >= 60) signal = 'STRONG LONG';
  else if (confidenceScore >= 25) signal = 'LONG';
  else if (confidenceScore > -25) signal = 'NEUTRAL';
  else if (confidenceScore > -60) signal = 'SHORT';
  else signal = 'STRONG SHORT';

  const summary = `${q.name || p?.companyName || q.symbol} trades at $${fmt(q.price)} with a ${pe > 0 ? fmt(pe, 1) + 'x P/E' : 'negative earnings'}. ` +
    `The 7-factor analysis yields a ${signal} signal (score: ${confidenceScore > 0 ? '+' : ''}${confidenceScore}). ` +
    (confidenceScore > 25 ? 'Positive earnings trends and favorable technicals support a bullish stance.' :
     confidenceScore < -25 ? 'Valuation concerns and weakening fundamentals suggest caution.' :
     'Mixed signals across factors warrant a neutral positioning until catalysts emerge.');

  const reasoning = `The analysis evaluates ${q.symbol} across earnings quality, market sentiment, analyst expectations, technical positioning, valuation, momentum, and risk. ` +
    `Strongest factor: ${Object.entries(factors).sort((a, b) => b[1] - a[1])[0][0]} (+${Object.entries(factors).sort((a, b) => b[1] - a[1])[0][1]}). ` +
    `Weakest factor: ${Object.entries(factors).sort((a, b) => a[1] - b[1])[0][0]} (${Object.entries(factors).sort((a, b) => a[1] - b[1])[0][1]}). ` +
    (confidenceScore > 25 ? 'The weight of evidence favors a long position, though position sizing should reflect individual risk tolerance.' :
     confidenceScore < -25 ? 'The overall picture is bearish â€” consider short exposure or avoiding the name until conditions improve.' :
     'The risk/reward is balanced â€” consider waiting for a clearer catalyst or entry point before taking a directional position.');

  return {
    company: q.name || p?.companyName || q.symbol,
    ticker: q.symbol,
    price: '$' + fmt(q.price),
    change: (q.changesPercentage >= 0 ? '+' : '') + fmt(q.changesPercentage, 2) + '%',
    marketCap: '$' + fmtB(q.marketCap),
    peRatio: pe ? fmt(pe, 1) : 'N/A',
    forwardPE: r?.priceEarningsRatioTTM ? fmt(r.priceEarningsRatioTTM, 1) : 'N/A',
    summary,
    confidenceScore,
    factors: {
      earnings: { score: earningsScore, detail: earningsDetail },
      sentiment: { score: sentimentScore, detail: sentimentDetail },
      analystTargets: { score: analystScore, detail: analystDetail },
      technicals: { score: technicalScore, detail: technicalDetail },
      valuation: { score: valuationScore, detail: valuationDetail },
      momentum: { score: momentumScore, detail: momentumDetail },
      risk: { score: riskScore, detail: riskDetail },
    },
    keyMetrics: {
      eps: q.eps != null ? '$' + fmt(q.eps) : 'N/A',
      revenue: inc[0]?.revenue ? '$' + fmtB(inc[0].revenue) : 'N/A',
      revenueGrowth: inc.length >= 5 && inc[4]?.revenue ? ((inc[0].revenue - inc[4].revenue) / Math.abs(inc[4].revenue) * 100 > 0 ? '+' : '') + fmt((inc[0].revenue - inc[4].revenue) / Math.abs(inc[4].revenue) * 100, 1) + '% YoY' : 'N/A',
      fullYearRevenue: p?.revenue ? '$' + fmtB(p.revenue) : 'N/A',
      analystConsensus: p?.rating || 'N/A',
      targetPrice: p?.targetConsensus ? '$' + fmt(p.targetConsensus) : 'N/A',
      shortInterest: 'N/A',
      weekHigh52: q.yearHigh ? '$' + fmt(q.yearHigh) : 'N/A',
      weekLow52: q.yearLow ? '$' + fmt(q.yearLow) : 'N/A',
      grossMargin: r?.grossProfitMarginTTM ? fmt(r.grossProfitMarginTTM * 100, 1) + '%' : 'N/A',
      operatingMargin: r?.operatingProfitMarginTTM ? fmt(r.operatingProfitMarginTTM * 100, 1) + '%' : 'N/A',
      cash: p?.cash ? '$' + fmtB(p.cash) : 'N/A',
      beta: (p?.beta || q?.beta) ? fmt(p?.beta || q?.beta, 2) : 'N/A',
    },
    catalysts,
    risks,
    reasoning,
  };
}

// â”€â”€ Rendering â”€â”€
function renderDashboard(d) {
  const changeColor = d.change.includes('-') ? 'var(--red)' : 'var(--green)';
  let signalColor;
  if (d.confidenceScore >= 60) signalColor = 'var(--strong-green)';
  else if (d.confidenceScore >= 25) signalColor = '#66bb6a';
  else if (d.confidenceScore > -25) signalColor = 'var(--yellow)';
  else if (d.confidenceScore > -60) signalColor = 'var(--red)';
  else signalColor = 'var(--strong-red)';

  let signalLabel;
  if (d.confidenceScore >= 60) signalLabel = 'STRONG LONG';
  else if (d.confidenceScore >= 25) signalLabel = 'LONG';
  else if (d.confidenceScore > -25) signalLabel = 'NEUTRAL';
  else if (d.confidenceScore > -60) signalLabel = 'SHORT';
  else signalLabel = 'STRONG SHORT';

  const angle = (Math.max(-100, Math.min(100, d.confidenceScore)) / 100) * 90;

  const factorHTML = Object.entries(d.factors).map(([k, v]) => {
    const label = k.replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase());
    const c = v.score >= 0 ? 'var(--green)' : 'var(--red)';
    return `<div class="factor-bar">
      <div class="factor-header">
        <span class="factor-label">${label}</span>
        <span class="factor-score" style="color:${c}">${v.score > 0 ? '+' : ''}${v.score}</span>
      </div>
      <div class="factor-track">
        <div class="factor-fill" style="width:${Math.abs(v.score)}%;background:linear-gradient(90deg,${c}30,${c})"></div>
      </div>
    </div>`;
  }).join('');

  const factorDetailHTML = Object.entries(d.factors).map(([k, v]) => {
    const c = v.score >= 0 ? '#66bb6a' : 'var(--red)';
    return `<div class="factor-detail">
      <div class="factor-detail-label" style="color:${c}">${k.replace(/([A-Z])/g, ' $1')} (${v.score > 0 ? '+' : ''}${v.score})</div>
      <div class="factor-detail-text">${v.detail}</div>
    </div>`;
  }).join('');

  const metricsHTML = [
    { t: 'EPS', v: d.keyMetrics.eps, c: '#00e676' },
    { t: 'Revenue', v: d.keyMetrics.revenue, s: d.keyMetrics.revenueGrowth, c: '#00b0ff' },
    { t: 'FY Revenue', v: d.keyMetrics.fullYearRevenue, c: '#00b0ff' },
    { t: 'P/E (TTM)', v: d.peRatio !== 'N/A' ? d.peRatio + 'x' : 'N/A', s: d.forwardPE !== 'N/A' ? 'Fwd: ' + d.forwardPE + 'x' : '', c: '#ffc107' },
    { t: 'Gross Margin', v: d.keyMetrics.grossMargin, c: '#e040fb' },
    { t: 'Op. Margin', v: d.keyMetrics.operatingMargin, c: '#e040fb' },
    { t: 'Analyst Target', v: d.keyMetrics.targetPrice, s: d.keyMetrics.analystConsensus, c: '#00e676' },
    { t: 'Short Interest', v: d.keyMetrics.shortInterest, c: '#ef5350' },
    { t: '52W High', v: d.keyMetrics.weekHigh52, c: '#00b0ff' },
    { t: '52W Low', v: d.keyMetrics.weekLow52, c: '#ff9800' },
    { t: 'Cash', v: d.keyMetrics.cash, c: '#00e676' },
    { t: 'Beta', v: d.keyMetrics.beta, c: '#ffc107' },
  ].map(m => `<div class="metric-card" style="border-top:2px solid ${m.c}40">
    <div class="metric-label">${m.t}</div>
    <div class="metric-value">${m.v || 'N/A'}</div>
    ${m.s ? `<div class="metric-sub">${m.s}</div>` : ''}
  </div>`).join('');

  const catalystsHTML = d.catalysts.map(c =>
    `<div class="list-item"><span class="list-bullet" style="color:var(--green)">â–¸</span>${c}</div>`
  ).join('');

  const risksHTML = d.risks.map(r =>
    `<div class="list-item"><span class="list-bullet" style="color:var(--red)">â–¸</span>${r}</div>`
  ).join('');

  return `
  <div class="fade-up">
    <!-- Ticker -->
    <div style="margin-bottom:16px">
      <div style="display:flex;align-items:baseline;gap:10px;margin-bottom:2px">
        <span class="ticker-exchange">${d.ticker.length <= 4 ? 'NASDAQ' : ''}:</span>
        <span class="ticker-symbol">${d.ticker}</span>
      </div>
      <div class="ticker-name">${d.company}</div>
      <div style="display:flex;align-items:baseline;gap:12px;flex-wrap:wrap">
        <span class="price-big">${d.price}</span>
        <span style="font-size:16px;font-weight:600;color:${changeColor}">${d.change}</span>
        <span style="font-size:12px;color:var(--dim)">MKT CAP ${d.marketCap}</span>
      </div>
    </div>

    <!-- Signal Gauge -->
    <div class="panel">
      <div class="panel-title">Signal Recommendation</div>
      <div style="text-align:center">
        <div class="gauge-wrap">
          <div class="gauge-arc"></div>
          <div class="gauge-inner"></div>
          <div class="gauge-needle-wrap">
            <div class="gauge-needle" style="transform:translateX(-50%) rotate(${angle}deg)">
              <div class="gauge-needle-tip"></div>
            </div>
          </div>
          <div class="gauge-center"></div>
          <div class="gauge-label-left">SHORT</div>
          <div class="gauge-label-right">LONG</div>
        </div>
        <div class="signal-label" style="color:${signalColor};text-shadow:0 0 24px ${signalColor}50">${signalLabel}</div>
        <div class="signal-score">Score: ${d.confidenceScore > 0 ? '+' : ''}${d.confidenceScore} / 100</div>
      </div>
    </div>

    <!-- Summary -->
    <div class="panel">
      <div class="panel-title">Executive Summary</div>
      <div style="font-size:12px;color:var(--muted);line-height:1.8">${d.summary}</div>
    </div>

    <!-- Metrics -->
    <div class="metrics-grid">${metricsHTML}</div>

    <!-- Factor Bars -->
    <div class="panel">
      <div class="panel-title">Factor Analysis</div>
      ${factorHTML}
    </div>

    <!-- Factor Details -->
    <div class="panel">
      <div class="panel-title">Factor Breakdown</div>
      ${factorDetailHTML}
    </div>

    <!-- Catalysts & Risks -->
    <div class="two-col">
      <div class="panel">
        <div class="panel-title">Catalysts (Bullish)</div>
        ${catalystsHTML}
      </div>
      <div class="panel">
        <div class="panel-title">Risk Factors (Bearish)</div>
        ${risksHTML}
      </div>
    </div>

    <!-- Thesis -->
    <div class="panel">
      <div class="panel-title">Investment Thesis</div>
      <div style="font-size:12px;color:#cbd5e1;line-height:1.9">${d.reasoning}</div>
    </div>

    <div class="footer">
      For informational purposes only â€” not financial advice.<br>
      Live data from Financial Modeling Prep. Always do your own due diligence.
    </div>
  </div>`;
}

// â”€â”€ Main â”€â”€
async function analyze() {
  const input = document.getElementById('tickerInput');
  const ticker = input.value.trim().toUpperCase();
  if (!ticker) return;

  if (!apiKey) { showApiModal(); return; }

  const btn = document.getElementById('analyzeBtn');
  const content = document.getElementById('content');

  btn.disabled = true;
  btn.textContent = 'ANALYZING...';

  content.innerHTML = `
    <div class="loading-wrap">
      <div class="radar">
        <div class="radar-ring"></div>
        <div class="radar-ring-inner"></div>
        <div class="radar-sweep"></div>
        <div class="radar-dot"></div>
      </div>
      <div style="font-size:16px;font-weight:700;letter-spacing:2px;margin-bottom:8px">ANALYZING ${ticker}</div>
      <div style="font-size:12px;color:var(--dim);animation:pulse 2s ease-in-out infinite;text-align:center">
        Fetching live market data & running 7-factor analysis...
      </div>
    </div>`;

  try {
    const rawData = await fetchStockData(ticker);
    const analysis = analyzeStock(rawData);
    content.innerHTML = renderDashboard(analysis);
  } catch (err) {
    content.innerHTML = `
      <div class="error-box">
        <div class="error-msg">âš  ${err.message}</div>
        <button class="error-btn" onclick="analyze()">RETRY</button>
        ${err.message.includes('Invalid API') || err.message.includes('403') || err.message.includes('401')
          ? '<button class="error-btn" onclick="showApiModal()">UPDATE API KEY</button>'
          : ''}
      </div>`;
  } finally {
    btn.disabled = false;
    btn.textContent = 'ANALYZE';
  }
}
</script>
</body>
</html>
